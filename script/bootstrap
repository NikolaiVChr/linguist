#!/bin/sh
set -e

# Resolve installation options
bundle=1
modules=1

case $1 in
  -b | --bundle-only)  unset modules ;;
  -m | --modules-only) unset bundle ;;
  *?*)
    status=1
    case $1 in
      -h | --help) status=0 ;;
      -*) printf 'Invalid option: %s\n' "$1" ;;
    esac
    printf 'Usage: %s [-b|--bundle-only] [-m|--modules-only]\n' "$0"
    exit $status
  ;;
esac

# Install missing gems
if [ "$bundle" ]; then
  bundle config --local path vendor/gems
  bundle check > /dev/null 2>&1 || bundle install
fi

# Fetch missing submodules
if [ "$modules" ]; then
  git submodule init
  git submodule sync --quiet
  git submodule update -j 4 --depth 1 || status=$?

  # TODO: Figure out why certain submodules are cloned with empty working trees
  git submodule foreach 'git restore --staged --worktree .'

  exit $status
fi
